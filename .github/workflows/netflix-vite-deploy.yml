name: Netflix DevSecOps - Vite Deploy

on:
  push:
    branches: [ "main" ]
  workflow_dispatch:

env:
  DOCKER_IMAGE: "sincamelcosq/netflix"
  DOCKER_USERNAME: "sincamelcosq"
  DOCKER_TOKEN: "dckr_pat_Fo1QRb4iRReMJUPLKeEsfzy1SPs"
  TMDB_V3_API_KEY: "6e4115a0ecbfcc96978f1556ba120fd6"
  SONAR_TOKEN: "squ_4f4d56f3af2990d4f0d7063b1fb291ee7a1b56b7"
  SONAR_HOST_URL: "http://184.169.217.89:9000" 
  SONAR_PROJECT_KEY: "netflix-clone-occ"
  SERVER_IP: "184.169.217.89"

jobs:
  code-analysis:
    name: 🔍 Code Analysis & Build
    runs-on: ubuntu-latest
    
    steps:
    - name: 📥 Checkout Repository
      uses: actions/checkout@v4
      
    - name: 🔧 Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '18'
        cache: 'yarn'
        
    - name: 📦 Install Dependencies
      run: |
        echo "📦 Installing Vite dependencies..."
        yarn install --frozen-lockfile
        
    - name: 🏗️ Build Vite Project
      run: |
        echo "🏗️ Building Vite project..."
        yarn build
        
    - name: 🔍 SonarQube Analysis (Optional)
      continue-on-error: true
      uses: sonarqube-github-actions/sonarqube-scanner-action@master
      env:
        GITHUB_TOKEN: ${{ github.token }}
        SONAR_TOKEN: ${{ env.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.projectKey=${{ env.SONAR_PROJECT_KEY }}
          -Dsonar.sources=src/
          -Dsonar.host.url=${{ env.SONAR_HOST_URL }}
          -Dsonar.login=${{ env.SONAR_TOKEN }}

  deploy-existing-image:
    name: 🚀 Deploy Netflix Container
    runs-on: ubuntu-latest
    needs: code-analysis
    
    steps:
    - name: 🔑 Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ env.DOCKER_USERNAME }}
        password: ${{ env.DOCKER_TOKEN }}
        
    - name: 📥 Pull Existing Jenkins Image
      run: |
        echo "📥 Pulling your existing Jenkins-built Netflix image..."
        docker pull ${{ env.DOCKER_IMAGE }}:latest
        
    - name: 🚀 Deploy via SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ env.SERVER_IP }}
        username: "ubuntu"
        key: |
          -----BEGIN OPENSSH PRIVATE KEY-----
          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
          -----END OPENSSH PRIVATE KEY-----
        port: 22
        timeout: 300
        script: |
          echo "🚀 Starting Netflix deployment..."
          
          # Ensure Docker is running
          if ! command -v docker &> /dev/null; then
            echo "📦 Installing Docker..."
            curl -fsSL https://get.docker.com -o get-docker.sh
            sudo sh get-docker.sh
            sudo usermod -aG docker $USER
            sudo systemctl start docker
            sudo systemctl enable docker
          fi
          
          # Stop existing container
          echo "🛑 Stopping existing Netflix container..."
          sudo docker stop netflix-app || true
          sudo docker rm netflix-app || true
          sudo docker image prune -f
          
          # Pull and run latest image
          echo "📥 Pulling Netflix image..."
          sudo docker pull ${{ env.DOCKER_IMAGE }}:latest
          
          echo "🏃 Deploying Netflix container..."
          sudo docker run -d \
            --name netflix-app \
            -p 8082:3000 \
            -p 80:3000 \
            --restart unless-stopped \
            --health-cmd="curl -f http://localhost:3000 || exit 1" \
            --health-interval=30s \
            --health-timeout=10s \
            --health-retries=3 \
            --health-start-period=40s \
            -e REACT_APP_TMDB_V3_API_KEY=${{ env.TMDB_V3_API_KEY }} \
            ${{ env.DOCKER_IMAGE }}:latest
            
          # Wait and verify
          echo "⏳ Waiting for deployment..."
          sleep 45
          
          if sudo docker ps | grep -q netflix-app; then
            echo "✅ Netflix deployed successfully!"
            echo "🌐 Netflix App: http://184.169.217.89:8082"
            echo "📊 SonarQube: http://184.169.217.89:9000"
            
            # Health check
            curl -s -o /dev/null -w "Health Status: %{http_code}\n" http://localhost:8082 || echo "Starting up..."
          else
            echo "❌ Deployment failed!"
            sudo docker logs netflix-app
            exit 1
          fi

  notification:
    name: 📧 Status Report
    runs-on: ubuntu-latest
    needs: [code-analysis, deploy-existing-image]
    if: always()
    
    steps:
    - name: 📧 Final Status
      run: |
        echo "🎬 NETFLIX DEPLOYMENT COMPLETE!"
        echo "📅 Date: $(date '+%Y-%m-%d %H:%M:%S')"
        echo "🌐 Netflix: http://184.169.217.89:8082"
        echo "📊 SonarQube: http://184.169.217.89:9000"
        echo "✅ Pipeline: Vite + TypeScript + Docker + SSH"
